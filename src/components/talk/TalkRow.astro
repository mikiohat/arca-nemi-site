---
import type { ImageMetadata } from "astro";

type Speaker = "arca" | "nemi" | "narration";
type Emotion = "normal" | "happy" | "angry" | "sad" | "joy";

export interface Props {
    speaker: Speaker;
    emotion?: Emotion; // narration のときは無視される
    text: string;
}

// アバター画像を src/assets から import
// スピード重視で、サイズは20〜40kB
import ArcaNormal from "@/assets/characters/arca/normal.webp";
import ArcaHappy from "@/assets/characters/arca/happy.webp";
import ArcaAngry from "@/assets/characters/arca/angry.webp";
import ArcaSad from "@/assets/characters/arca/sad.webp";
import ArcaJoy from "@/assets/characters/arca/joy.webp";

import NemiNormal from "@/assets/characters/nemi/normal.webp";
import NemiHappy from "@/assets/characters/nemi/happy.webp";
import NemiAngry from "@/assets/characters/nemi/angry.webp";
import NemiSad from "@/assets/characters/nemi/sad.webp";
import NemiJoy from "@/assets/characters/nemi/joy.webp";

const { speaker, text } = Astro.props;
const emotion: Emotion = Astro.props.emotion ?? "normal";

const isNarration = speaker === "narration";

// アバターのマップ（静的 import → 動的選択）
// ImageMetadata を使うマップ
const avatars: Record<
    Exclude<Speaker, "narration">,
    Record<Emotion, ImageMetadata>
> = {
    arca: {
        normal: ArcaNormal,
        happy: ArcaHappy,
        angry: ArcaAngry,
        sad: ArcaSad,
        joy: ArcaJoy,
    },
    nemi: {
        normal: NemiNormal,
        happy: NemiHappy,
        angry: NemiAngry,
        sad: NemiSad,
        joy: NemiJoy,
    },
};

// 長いifよりシンプルに speaker から alignment を決める
const alignment: "left" | "right" | "center" = isNarration
    ? "center"
    : speaker === "arca"
      ? "left"
      : "right";

// narration のときは null、それ以外は ImageMetadata
const avatar = isNarration
    ? null
    : avatars[speaker as Exclude<Speaker, "narration">][emotion];
---

<div
    class={[
        "talk-row",
        `talk-row--${alignment}`,
        isNarration ? "talk-row--narration" : "",
    ]
        .filter(Boolean)
        .join(" ")}
>
    {
        !isNarration && avatar && (
            <div class="talk-row__avatar">
                <img
                    src={avatar.src}
                    alt={speaker === "arca" ? "Arca" : "Nemi"}
                    loading="lazy"
                    width={avatar.width}
                    height={avatar.height}
                    class="avatar"
                />
            </div>
        )
    }

    <div
        class={[
            "talk-row__bubble",
            isNarration ? "bubble--narration" : "",
            !isNarration && speaker === "arca" ? "bubble--arca" : "",
            !isNarration && speaker === "nemi" ? "bubble--nemi" : "",
        ]
            .filter(Boolean)
            .join(" ")}
    >
        {text}
    </div>
</div>

<style>
    .talk-row {
        display: flex;
        gap: 0.6rem;
        margin: 0.9rem 0;
        align-items: flex-start;
        width: 100%;
    }

    .talk-row--left {
        flex-direction: row;
        justify-content: flex-start;
    }

    .talk-row--right {
        flex-direction: row-reverse;
        justify-content: flex-start;
    }

    .talk-row--center {
        flex-direction: column;
        align-items: center;
        justify-content: center;
    }

    .talk-row__avatar {
        flex: 0 0 auto;
    }

    .avatar {
        display: block;
        width: 48px;
        height: 48px;
        border-radius: 9999px;
        object-fit: cover;
    }

    .talk-row__bubble {
        max-width: 80%;
        padding: 0.7rem 0.9rem;
        border-radius: 0.9rem;
        font-size: 0.95rem;
        line-height: 1.6;
        word-wrap: break-word;
    }

    /* アルカ：青系 */
    .bubble--arca {
        background: #2563eb; /* blue-600-ish */
        color: #ffffff;
    }

    /* ネミ：赤系 */
    .bubble--nemi {
        background: #dc2626; /* red-600-ish */
        color: #ffffff;
    }

    /* ナレーション：灰色＋中央寄せ */
    .talk-row--narration .talk-row__bubble {
        max-width: 100%;
        text-align: center;
    }

    .bubble--narration {
        background: #e5e7eb; /* gray-200-ish */
        color: #111827; /* gray-900-ish */
    }

    @media (min-width: 768px) {
        .talk-row {
            gap: 0.8rem;
            margin: 1.1rem 0;
        }

        .talk-row__bubble {
            max-width: 70%;
            font-size: 1rem;
        }
    }
</style>
